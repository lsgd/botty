# Birthday Wishes Plugin

Automatically sends personalized birthday wishes based on a CSV file. Messages are generated by GPT-4o for truly personal, unique wishes. Sent randomly between 7:00-9:00 AM, but only if no authorized user has messaged in that chat on the birthday.

## Features

- ğŸ“… **Automatic Birthday Detection**: Reads birthdays from CSV file
- ğŸ¤– **GPT-4o Generated Messages**: Each wish is uniquely generated, never repetitive
- ğŸ‚ **Age-Aware**: Mentions age with correct ordinals (21st, 22nd, 31st, etc.) and highlights milestones
- ğŸ **Highly Personalized**: Customizable by language, formality, gender, and sender
- ğŸ‘¤ **Smart Name Usage**: First name for informal, last name for formal messages
- â° **Smart Scheduling**: Random delivery between a configurable 7:00-9:00 AM (timezone-aware) window
- ğŸ§  **Smart Skipping**: Won't send if authorized user already messaged that day
- ğŸŒ **Multi-Language**: Supports English, German, and Italian
- âœ… **Validation**: Checks phone numbers and CSV format on load

## CSV File Format

Create a file at `data/birthdays.csv` with the following columns:

| Column | Description | Example | Required |
|--------|-------------|---------|----------|
| `chatId` | Phone number (+format) or group ID (@g.us) | `+491707352725` | Yes |
| `firstName` | First name (used for informal messages) | `Max` | Yes |
| `lastName` | Last name (used for formal messages) | `MÃ¼ller` | Yes |
| `sex` | Gender for message personalization | `male`, `female`, or `neutral` | Yes |
| `birthDate` | Full birthday in YYYY-MM-DD format | `1985-03-15` | Yes |
| `language` | Language for birthday message | `en`, `de`, or `it` | Yes |
| `formality` | Message formality level | `formal` or `informal` | Yes |
| `enabled` | Enable/disable this entry | `true` or `false` | No (default: true) |

**Name Usage:**
- **Informal**: Uses first name only (e.g., "Happy Birthday, Max!")
- **Formal**: Uses last name only with title (e.g., "Dear Mr. MÃ¼ller," or "Sehr geehrter Herr MÃ¼ller,")

### Example CSV

```csv
chatId,firstName,lastName,sex,birthDate,language,formality,enabled
+491707352725,Max,MÃ¼ller,male,1985-03-15,de,informal,true
+491234567890,Sarah,Schmidt,female,1990-07-22,de,formal,true
120363123456789@g.us,John,Doe,male,1980-12-25,en,informal,true
+447123456789,Jane,Smith,female,1995-01-10,en,formal,false
```

**Note:** The birth year is used to calculate age and personalize messages (e.g., "for your 40th birthday").

## Phone Number Format

Phone numbers **must** be in international format:
- âœ… Correct: `+491707352725`
- âŒ Wrong: `491707352725`, `+49 170 735 2725`, `+49-170-735-2725`

Group chats use their WhatsApp group ID format: `120363123456789@g.us`

### How to Get Chat IDs

**For any chat or group:**
1. Open the chat/group in WhatsApp
2. Send the command: `!chatid`
3. The bot will reply with the chat ID and type
4. Copy the ID to your `birthdays.csv`

**Example response:**
```
ğŸ“‹ Chat ID

120363123456789@g.us

Name: Family Group
```

## Message Examples

All messages are **generated by GPT-4o** in real-time, so each one is unique! Here are some example styles:

### German, Informal, Turning 40
```
Heute wird dein 40. Geburtstag gefeiert, Max! ğŸ‰ MÃ¶ge dieses besondere Jahr voller unvergesslicher Momente und groÃŸer Freuden sein. GenieÃŸe deinen Tag in vollen ZÃ¼gen! ğŸ‚
```

### German, Formal, Turning 55 (Uses Last Name)
```
Sehr geehrter Herr MÃ¼ller, zu Ihrem 55. Geburtstag gratuliere ich Ihnen herzlich. MÃ¶ge das kommende Jahr Ihnen Gesundheit und viele schÃ¶ne Erlebnisse bringen. ğŸ‚
```

### English, Informal, Turning 21 (Uses First Name)
```
Your 21st birthday is here, John! ğŸˆ Time to celebrate this amazing milestone and all the exciting adventures ahead. Have an incredible day! ğŸ‰
```

**Note:** These are example styles. GPT-4o generates fresh, unique messages for each birthday based on the person's age, formality level, and language preferences. Ordinal numbers are handled correctly (21st, 22nd, 23rd, 31st, etc.).

## How It Works

1. **Startup**: Bot loads `data/birthdays.csv` and validates all entries (checks phone formats, dates, etc.)
2. **Daily Check**: Every day at `BIRTHDAY_CHECK_HOUR` (default 06:00) in `BOT_TIMEZONE`, the bot reloads the CSV and checks for today's birthdays (matching month-day, ignoring year)
3. **Age Calculation**: Calculates current age from birth year for personalization using the configured timezone
4. **Scheduling**: For each birthday, schedules a message randomly between `BIRTHDAY_WINDOW_START` and `BIRTHDAY_WINDOW_END` (default 7:00-9:00 AM)
5. **Smart Skip**: Before sending, checks if any authorized user messaged in that chat today (persisted in `data/birthday-message-tracker.json`)
6. **GPT-4o Generation**: Generates a unique, personalized birthday wish using GPT-4o with age, formality, language
7. **Send**: If no authorized user messaged, sends the AI-generated birthday wish even after restarts (missed jobs are rescheduled on boot)

## Commands

### `!birthdays`
Show a numbered list of all birthdays with scheduling information.

**Example:**
```
!birthdays
```

**Response:**
```
ğŸ‚ Birthdays

Total: 4
Today: 1
Scheduled messages: 1

*All Birthdays:*
1. Max MÃ¼ller - 15.03. (informal)
2. Sarah Schmidt - 22.07. (formal)
3. John Doe - 25.12. (informal)
4. Jane Smith - 10.01. (formal)

ğŸ’¡ Test a message with: !birthdays-test <number>
```

### `!birthdays-reload`
Reload the CSV file and re-check for today's birthdays. Useful after editing the CSV.

**Example:**
```
!birthdays-reload
```

**Response:**
```
âœ… CSV reloaded!

Birthdays: 15
Today: 2
```

### `!birthdays-test <number>`
Generate and preview a test birthday message for a specific person from your birthday list. The message will be shown in your current chat as a quoted preview, not sent to the actual recipient.

**Example:**
```
!birthdays-test 1
```

**Response:**
```
ğŸ§ª Testing for: Max MÃ¼ller

Generating message...

âœ… Generated Message:

> Heute wird dein 40. Geburtstag gefeiert, Max! ğŸ‰ MÃ¶ge dieses besondere Jahr voller unvergesslicher Momente und groÃŸer Freuden sein. GenieÃŸe deinen Tag in vollen ZÃ¼gen! ğŸ‚
```

**Use Cases:**
- Test message generation before a birthday
- Preview how formal vs informal messages look
- Verify GPT-4o is generating appropriate messages
- Check that age calculations are correct

### `!chatid`
Get the chat ID for the current chat or group. This is a general command useful for configuration.

**Example:**
```
!chatid
```

**Response:**
```
ğŸ“‹ Chat ID

120363123456789@g.us

Name: Family Group
```

## CSV Validation

On startup, the bot validates all CSV entries and prints any errors:

```
[BirthdayCSV] Loading birthdays from data/birthdays.csv
[BirthdayCSV] Loaded 10 entries from CSV

[BirthdayCSV] âŒ Found 2 invalid entries:

  Line 3 (Max MÃ¼ller):
    - Invalid phone number format: 491707352725. Must be international format like +491707352725

  Line 5 (John Doe):
    - Invalid birthDate format: 15-03. Must be YYYY-MM-DD (e.g., 1985-03-15)

[BirthdayCSV] âœ… Successfully loaded 8 valid birthdays
```

## Common Validation Errors

| Error | Cause | Fix |
|-------|-------|-----|
| Invalid chatId format | Missing `+` or wrong format | Use `+country_code_number` |
| Invalid phone number format | Not international format | Use `+491707352725` format |
| Invalid birthDate format | Wrong date format | Use `YYYY-MM-DD` like `1985-03-15` |
| Invalid date | Date doesn't exist | Check year, month and day are valid |
| Invalid birth year | Year out of range | Must be between 1900 and current year |
| Invalid sex | Unknown gender value | Use `male`, `female`, or `neutral` |
| Invalid language | Unsupported language | Use `en`, `de`, or `it` |
| Invalid formality | Unknown formality value | Use `formal` or `informal` |
| firstName is required | Missing first name | Add person's first name |
| lastName is required | Missing last name | Add person's last name |

## Customization

### Adding More Languages

To add support for more languages (e.g., French, Spanish):

1. **Update message generator** (`src/plugins/birthday/message-generator.js`):
   - Add language-specific prompts in the `buildPrompt()` method
   - Add fallback messages in the `generateFallbackMessage()` method

2. **Update CSV validation** (`src/plugins/birthday/csv-loader.js`):
   - Add your language code to the validation array (defaults are `['en', 'de', 'it']`)

3. **Test**: GPT-4o will automatically generate messages in the specified language!

Example for French:
```javascript
// In buildPrompt()
if (language === 'fr') {
  prompt += 'Ã‰cris un message d\'anniversaire en franÃ§ais. ';
}
```

### Changing Time Window

Set the environment variables `BIRTHDAY_WINDOW_START` and `BIRTHDAY_WINDOW_END` (hours in 24h format) to shift the send window without touching the code.

### Changing Daily Check Time

Set `BIRTHDAY_CHECK_HOUR` to control when the cron job reloads the CSV and schedules messages.

## Troubleshooting

### Birthdays not being sent

1. **Check CSV is loaded**: Run `!birthdays` to verify birthdays are loaded
2. **Check date format**: Birthdays must be in `YYYY-MM-DD` format (e.g., `1985-03-15` for March 15, 1985)
3. **Check enabled**: Ensure `enabled` column is `true`
4. **Check time**: Messages send between `BIRTHDAY_WINDOW_START`-`BIRTHDAY_WINDOW_END` in `BOT_TIMEZONE`
5. **Check authorized messages**: If you already messaged in that chat today, birthday won't be sent

### CSV validation errors

1. **Phone numbers**: Must be in international format with `+`: `+491707352725`
2. **Group IDs**: Use the exact group ID format from WhatsApp
3. **Date format**: Use `YYYY-MM-DD` not `DD-MM-YYYY` or other formats
4. **Birth year**: Must be between 1900 and current year
5. **Column names**: Must match exactly (case-sensitive)

### Messages sent at wrong time

- Bot sends randomly between the configured window (`BIRTHDAY_WINDOW_START`-`BIRTHDAY_WINDOW_END`) in `BOT_TIMEZONE`
- If the bot restarts during the sending window, it rehydrates the schedule immediately
- If the bot starts after the window, messages send within 1 minute so nobody is skipped

### Testing

There are two ways to test birthday messages:

#### Method 1: Test Command (Recommended)
1. Run `!birthdays` to see the numbered list
2. Run `!birthdays-test <number>` to generate a preview message
3. The message appears in your current chat, not sent to the recipient
4. You can test multiple times to see GPT-4o's variety

**Example:**
```
!birthdays
!birthdays-test 1
```

#### Method 2: Live Test with Real Scheduling
1. Create a test entry with today's date:
   ```csv
   +your_number,Test,Person,neutral,1990-MM-DD,en,informal,false,TestBot,true
   ```
   (Replace MM-DD with today's month-day, e.g., `1990-11-18` for November 18th)

2. Reload CSV: `!birthdays-reload`
3. Check status: `!birthdays`
4. Wait for scheduled time or restart bot

## File Structure

```
src/plugins/birthday/
â”œâ”€â”€ index.js                  # Main plugin class
â”œâ”€â”€ birthday-scheduler.js     # Scheduling and sending logic
â”œâ”€â”€ message-generator.js      # Message templates and generation
â”œâ”€â”€ message-tracker.js        # Track authorized user messages
â””â”€â”€ csv-loader.js            # Load and validate CSV file

data/
â”œâ”€â”€ birthdays.csv                    # Your birthday data (create this)
â”œâ”€â”€ birthdays.csv.example            # Example CSV file
â””â”€â”€ birthday-message-tracker.json    # Tracks chats already messaged today
```

## Privacy & Security

- Birthday data is stored **locally only** in `data/birthdays.csv`
- No data is sent to external servers except WhatsApp messages
- Use `.gitignore` to avoid committing `data/birthdays.csv` (it's already excluded)
- Restrict access to the CSV file as it contains phone numbers

## API Costs

Birthday messages are generated using GPT-4o, which incurs a small cost per message:

- **GPT-4o cost**: ~$0.01-0.02 per birthday message (depending on complexity)
- For 50 birthdays/year: ~$0.50-1.00/year
- Very affordable for personal use!

**Fallback**: If the OpenAI API fails, the bot automatically falls back to a simple template message.

## Tips

1. **Test before birthdays**: Use `!birthdays-test <number>` to preview messages before the actual birthday
2. **Name formatting**: Make sure to split first and last names properly for correct formal addressing
3. **Test formality levels**: Use `!birthdays-test` to compare formal vs informal messages
4. **Message variety**: Test multiple times to see GPT-4o's creative variations
5. **Milestone birthdays**: GPT-4o automatically highlights special ages (18, 21, 25, 30, 40, 50, etc.)
6. **Ordinal numbers**: GPT-4o handles all ordinals correctly (1st, 2nd, 3rd, 21st, 22nd, 31st, etc.)
7. **Group chats**: Birthday wishes work in group chats too!
8. **Disable temporarily**: Set `enabled=false` instead of deleting entries
9. **Backup your CSV**: Keep a backup of `data/birthdays.csv`
10. **Privacy**: Birth year is only used for age calculation, never shared
11. **High creativity**: Messages use high temperature (1.3) for maximum variety
